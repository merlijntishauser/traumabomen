name: Deploy to production

on:
  push:
    tags:
      - "v*"

env:
  REGISTRY: europe-west4-docker.pkg.dev
  IMAGE_PREFIX: europe-west4-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/traumabomen

permissions:
  actions: write
  contents: write
  id-token: write
  issues: write

jobs:
  build-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Login to ghcr.io
        run: echo "${{ secrets.DHI_TOKEN }}" | docker login dhi.io -u ${{ secrets.DHI_USERNAME }} --password-stdin

      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Build and push API image
        run: |
          docker build --target production \
            -t ${{ env.IMAGE_PREFIX }}/api:${{ github.ref_name }} \
            -t ${{ env.IMAGE_PREFIX }}/api:latest \
            ./api
          docker push ${{ env.IMAGE_PREFIX }}/api:${{ github.ref_name }}
          docker push ${{ env.IMAGE_PREFIX }}/api:latest

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Build and push frontend image
        run: |
          docker build --target production \
            -t ${{ env.IMAGE_PREFIX }}/frontend:${{ github.ref_name }} \
            -t ${{ env.IMAGE_PREFIX }}/frontend:latest \
            ./frontend
          docker push ${{ env.IMAGE_PREFIX }}/frontend:${{ github.ref_name }}
          docker push ${{ env.IMAGE_PREFIX }}/frontend:latest

  deploy:
    needs: [build-api, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v3

      - name: Run migrations
        run: |
          gcloud run jobs deploy traumabomen-migrate \
            --image=${{ env.IMAGE_PREFIX }}/api:${{ github.ref_name }} \
            --region=${{ vars.GCP_REGION }} \
            --set-cloudsql-instances=${{ vars.CLOUD_SQL_INSTANCE }} \
            --set-secrets=DATABASE_URL=db-url:latest,JWT_SECRET_KEY=jwt-secret:latest \
            --command=python3,-m,alembic,upgrade,head \
            --wait

      - name: Deploy API
        run: |
          gcloud run deploy traumabomen-api \
            --image=${{ env.IMAGE_PREFIX }}/api:${{ github.ref_name }} \
            --region=${{ vars.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8000 \
            --add-cloudsql-instances=${{ vars.CLOUD_SQL_INSTANCE }} \
            --set-secrets="\
              DATABASE_URL=db-url:latest,\
              JWT_SECRET_KEY=jwt-secret:latest,\
              SMTP_HOST=smtp-host:latest,\
              SMTP_PORT=smtp-port:latest,\
              SMTP_USER=smtp-user:latest,\
              SMTP_PASSWORD=smtp-password:latest" \
            --set-env-vars="\
              JWT_ALGORITHM=HS256,\
              REQUIRE_EMAIL_VERIFICATION=true,\
              SMTP_FROM=merlijn@traumatrees.org,\
              APP_BASE_URL=https://www.traumatrees.org,\
              SMOKETEST_EMAIL=${{ secrets.SMOKETEST_EMAIL }},\
              ENABLE_WAITLIST=true,\
              MAX_ACTIVE_USERS=20,\
              FEEDBACK_EMAIL=feedback@traumatrees.org" \
            --min-instances=0 \
            --max-instances=4 \
            --memory=256Mi \
            --cpu=1 \
            --cpu-boost \
            --timeout=60 \
            --startup-probe httpGet.path=/health,httpGet.port=8000,initialDelaySeconds=0,periodSeconds=4,failureThreshold=8

      - name: Deploy frontend
        run: |
          API_URL=$(gcloud run services describe traumabomen-api \
            --region=${{ vars.GCP_REGION }} \
            --format="value(status.url)")

          gcloud run deploy traumabomen-frontend \
            --image=${{ env.IMAGE_PREFIX }}/frontend:${{ github.ref_name }} \
            --region=${{ vars.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="API_URL=${API_URL}" \
            --min-instances=0 \
            --max-instances=4 \
            --memory=128Mi \
            --cpu=1 \
            --timeout=60 \
            --startup-probe httpGet.path=/healthz,httpGet.port=8080,initialDelaySeconds=0,periodSeconds=4,failureThreshold=3

  smoketest:
    needs: [deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Production smoketest
        env:
          SMOKETEST_EMAIL: ${{ secrets.SMOKETEST_EMAIL }}
          SMOKETEST_PASSWORD: ${{ secrets.SMOKETEST_PASSWORD }}
        run: |
          retry() {
            local name="$1" url="$2" method="${3:-GET}" body="$4" expect="$5"
            for i in 1 2 3 4 5; do
              echo "[$name] attempt $i..."
              if [ "$method" = "POST" ]; then
                resp=$(curl -sf -X POST -H "Content-Type: application/json" -d "$body" "$url" 2>&1) && \
                echo "$resp" | grep -q "$expect" && echo "[$name] OK" && return 0
              else
                resp=$(curl -sf "$url" 2>&1) && \
                echo "$resp" | grep -q "$expect" && echo "[$name] OK" && return 0
              fi
              echo "[$name] not ready, waiting 10s..."
              sleep 10
            done
            echo "[$name] FAILED after 5 attempts"
            echo "Last response: $resp"
            return 1
          }

          retry "Frontend (traumatrees.org)" \
            "https://www.traumatrees.org/" GET "" "<html"

          retry "Frontend (traumabomen.nl)" \
            "https://www.traumabomen.nl/" GET "" "<html"

          retry "API health" \
            "https://www.traumatrees.org/api/health" GET "" '"ok"'

          retry "Auth login" \
            "https://www.traumatrees.org/api/auth/login" POST \
            "{\"email\":\"${SMOKETEST_EMAIL}\",\"password\":\"${SMOKETEST_PASSWORD}\"}" \
            "access_token"

  performance-check:
    needs: [smoketest]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Lighthouse
        run: |
          npm install -g lighthouse
          npx puppeteer browsers install chrome

      - name: Performance check
        env:
          SMOKETEST_EMAIL: ${{ secrets.SMOKETEST_EMAIL }}
          SMOKETEST_PASSWORD: ${{ secrets.SMOKETEST_PASSWORD }}
        run: |
          CHROME_PATH=$(find /home/runner/.cache/puppeteer -name chrome -type f | head -1)
          export CHROME_PATH
          ./scripts/performance-check.sh https://www.traumatrees.org

      - name: Update CI baseline
        run: |
          cp .performance-current.json .performance-baseline.ci.json
          if git diff --quiet .performance-baseline.ci.json; then
            echo "CI baseline unchanged"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .performance-baseline.ci.json
            git commit -m "Update CI performance baseline"
            git push origin HEAD:main
          fi

  security-scan:
    needs: [smoketest]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Obtain auth token
        id: auth
        env:
          SMOKETEST_EMAIL: ${{ secrets.SMOKETEST_EMAIL }}
          SMOKETEST_PASSWORD: ${{ secrets.SMOKETEST_PASSWORD }}
        run: |
          TOKEN=$(curl -sf -X POST \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"${SMOKETEST_EMAIL}\",\"password\":\"${SMOKETEST_PASSWORD}\"}" \
            "https://www.traumatrees.org/api/auth/login" \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")
          echo "::add-mask::${TOKEN}"
          echo "token=${TOKEN}" >> "$GITHUB_OUTPUT"

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        env:
          ZAP_AUTH_HEADER: "Authorization"
          ZAP_AUTH_HEADER_VALUE: "Bearer ${{ steps.auth.outputs.token }}"
          ZAP_AUTH_HEADER_SITE: "www.traumatrees.org"
        with:
          target: "https://www.traumatrees.org"
          rules_file_name: ".zap/rules.tsv"
          fail_action: "false"

      - name: Check ZAP results
        run: |
          python3 -c "
          import json, sys, glob

          reports = glob.glob('**/report_json.json', recursive=True)
          if not reports:
            print('::error::No ZAP report found')
            sys.exit(1)

          with open(reports[0]) as f:
            data = json.load(f)

          sites = data.get('site', [])
          if isinstance(sites, dict):
            sites = [sites]

          blockers = []
          for site in sites:
            for a in site.get('alerts', []):
              if a.get('riskcode', '0') in ('3', '4'):
                blockers.append(a)

          for a in blockers:
            level = 'HIGH' if a['riskcode'] == '3' else 'CRITICAL'
            print(f'  [{level}] {a[\"name\"]}')
            for i in a.get('instances', [])[:3]:
              print(f'    {i.get(\"method\",\"\")} {i.get(\"uri\",\"\")}')

          if blockers:
            print(f'::error::{len(blockers)} high/critical ZAP findings')
            sys.exit(1)

          print('No high/critical ZAP findings')
          "

      - name: Trigger Nuclei scan (every 5th deploy)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ $(( ${{ github.run_number }} % 5 )) -eq 0 ]; then
            echo "Run #${{ github.run_number }} is a 5th deploy, triggering Nuclei scan"
            gh workflow run nuclei-scan.yml
          else
            echo "Run #${{ github.run_number }}, skipping Nuclei (runs every 5th deploy)"
          fi

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: zap-scan-reports
          path: |
            report_json.json
            report_md.md
            report_html.html
          retention-days: 30
