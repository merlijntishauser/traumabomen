name: Deploy to production

on:
  push:
    tags:
      - "v*"

env:
  REGISTRY: europe-west4-docker.pkg.dev
  IMAGE_PREFIX: europe-west4-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/traumabomen

permissions:
  contents: read
  id-token: write

jobs:
  build-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to ghcr.io
        run: echo "${{ secrets.DHI_TOKEN }}" | docker login dhi.io -u ${{ secrets.DHI_USERNAME }} --password-stdin

      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Build and push API image
        run: |
          docker build --target production \
            -t ${{ env.IMAGE_PREFIX }}/api:${{ github.ref_name }} \
            -t ${{ env.IMAGE_PREFIX }}/api:latest \
            ./api
          docker push ${{ env.IMAGE_PREFIX }}/api:${{ github.ref_name }}
          docker push ${{ env.IMAGE_PREFIX }}/api:latest

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Build and push frontend image
        run: |
          docker build --target production \
            -t ${{ env.IMAGE_PREFIX }}/frontend:${{ github.ref_name }} \
            -t ${{ env.IMAGE_PREFIX }}/frontend:latest \
            ./frontend
          docker push ${{ env.IMAGE_PREFIX }}/frontend:${{ github.ref_name }}
          docker push ${{ env.IMAGE_PREFIX }}/frontend:latest

  deploy:
    needs: [build-api, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v3

      - name: Run migrations
        run: |
          gcloud run jobs deploy traumabomen-migrate \
            --image=${{ env.IMAGE_PREFIX }}/api:${{ github.ref_name }} \
            --region=${{ vars.GCP_REGION }} \
            --set-cloudsql-instances=${{ vars.CLOUD_SQL_INSTANCE }} \
            --set-secrets=DATABASE_URL=db-url:latest,JWT_SECRET_KEY=jwt-secret:latest \
            --command=python3,-m,alembic,upgrade,head \
            --wait

      - name: Deploy API
        run: |
          gcloud run deploy traumabomen-api \
            --image=${{ env.IMAGE_PREFIX }}/api:${{ github.ref_name }} \
            --region=${{ vars.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8000 \
            --add-cloudsql-instances=${{ vars.CLOUD_SQL_INSTANCE }} \
            --set-secrets="\
              DATABASE_URL=db-url:latest,\
              JWT_SECRET_KEY=jwt-secret:latest,\
              SMTP_HOST=smtp-host:latest,\
              SMTP_PORT=smtp-port:latest,\
              SMTP_USER=smtp-user:latest,\
              SMTP_PASSWORD=smtp-password:latest" \
            --set-env-vars="\
              JWT_ALGORITHM=HS256,\
              REQUIRE_EMAIL_VERIFICATION=true,\
              SMTP_FROM=merlijn@traumatrees.org,\
              APP_BASE_URL=https://traumatrees.org" \
            --min-instances=0 \
            --max-instances=4 \
            --memory=256Mi \
            --cpu=1 \
            --timeout=60

      - name: Deploy frontend
        run: |
          API_URL=$(gcloud run services describe traumabomen-api \
            --region=${{ vars.GCP_REGION }} \
            --format="value(status.url)")

          gcloud run deploy traumabomen-frontend \
            --image=${{ env.IMAGE_PREFIX }}/frontend:${{ github.ref_name }} \
            --region=${{ vars.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="API_URL=${API_URL}" \
            --min-instances=0 \
            --max-instances=4 \
            --memory=128Mi \
            --cpu=1 \
            --timeout=60

  smoketest:
    needs: [deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Production smoketest
        env:
          SMOKETEST_EMAIL: ${{ secrets.SMOKETEST_EMAIL }}
          SMOKETEST_PASSWORD: ${{ secrets.SMOKETEST_PASSWORD }}
        run: |
          retry() {
            local name="$1" url="$2" method="${3:-GET}" body="$4" expect="$5"
            for i in 1 2 3 4 5; do
              echo "[$name] attempt $i..."
              if [ "$method" = "POST" ]; then
                resp=$(curl -sf -X POST -H "Content-Type: application/json" -d "$body" "$url" 2>&1) && \
                echo "$resp" | grep -q "$expect" && echo "[$name] OK" && return 0
              else
                resp=$(curl -sf "$url" 2>&1) && \
                echo "$resp" | grep -q "$expect" && echo "[$name] OK" && return 0
              fi
              echo "[$name] not ready, waiting 10s..."
              sleep 10
            done
            echo "[$name] FAILED after 5 attempts"
            echo "Last response: $resp"
            return 1
          }

          retry "Frontend (traumatrees.org)" \
            "https://traumatrees.org/" GET "" "<html"

          retry "Frontend (traumabomen.nl)" \
            "https://www.traumabomen.nl/" GET "" "<html"

          retry "API health" \
            "https://traumatrees.org/api/health" GET "" '"ok"'

          retry "Auth login" \
            "https://traumatrees.org/api/auth/login" POST \
            "{\"email\":\"${SMOKETEST_EMAIL}\",\"password\":\"${SMOKETEST_PASSWORD}\"}" \
            "access_token"
