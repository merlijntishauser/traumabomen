name: Nuclei Security Scan

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  nuclei:
    runs-on: ubuntu-latest
    steps:
      - name: Nuclei Scan
        run: |
          mkdir -p results
          docker run --rm \
            -v "${{ github.workspace }}/results:/output" \
            projectdiscovery/nuclei:latest \
            -u "https://www.traumatrees.org" \
            -u "https://www.traumabomen.nl" \
            -severity critical,high \
            -tags cve,misconfig,exposure,tech \
            -exclude-tags dos \
            -rate-limit 10 \
            -jsonl -output /output/nuclei-report.jsonl

          if [ -f results/nuclei-report.jsonl ] && grep -qE '"severity":"(critical|high)"' results/nuclei-report.jsonl; then
            echo "::error::Nuclei found critical/high severity issues"
            python3 -c "
          import json
          for line in open('results/nuclei-report.jsonl'):
            f = json.loads(line)
            sev = f.get('info', {}).get('severity', 'unknown').upper()
            name = f.get('info', {}).get('name', 'unknown')
            matched = f.get('matched-at', '')
            print(f'  [{sev}] {name} - {matched}')
          "
            exit 1
          fi

          echo "No critical/high Nuclei findings"

      - name: Upload Nuclei report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: nuclei-report
          path: results/
          retention-days: 30
